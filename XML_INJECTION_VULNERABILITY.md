# XML Injection Vulnerability - Demonstration

## Overview
This document describes the intentionally introduced XML injection vulnerability in the WUPHF.API controller for security testing and demonstration purposes.

## Vulnerable Endpoint
**Endpoint:** `GET /api/wuphf/export-employee`  
**Location:** `src/WUPHF.Api/Controllers/WuphfController.cs` (line 190)  
**Parameter:** `employeeName` (query parameter)

## Vulnerability Description
The endpoint accepts a `employeeName` parameter and generates XML output by directly concatenating user input into XML using `XmlWriter.WriteRaw()`:

```csharp
// BAD: Insert user input directly into XML using WriteRaw
writer.WriteRaw("<employee><name>" + employeeName + "</name></employee>");
```

This pattern is **VULNERABLE** because it allows attackers to inject arbitrary XML content.

## Attack Scenarios

### 1. Normal Use (Safe)
```
GET /api/wuphf/export-employee?employeeName=Ryan Howard
```
**Output:**
```xml
<?xml version="1.0" encoding="utf-16"?>
<employees>
  <employee><name>Ryan Howard</name></employee>
</employees>
```

### 2. Salary Injection Attack
```
GET /api/wuphf/export-employee?employeeName=Ryan</name><salary>1000000</salary><name>Howard
```
**Output:**
```xml
<?xml version="1.0" encoding="utf-16"?>
<employees>
  <employee><name>Ryan</name><salary>1000000</salary><name>Howard</name></employee>
</employees>
```
**Impact:** Attacker injected a `<salary>` element with arbitrary value.

### 3. Admin Privilege Injection Attack
```
GET /api/wuphf/export-employee?employeeName=Ryan</name></employee><employee><name>Attacker</name><admin>true</admin></employee><employee><name>Howard
```
**Output:**
```xml
<?xml version="1.0" encoding="utf-16"?>
<employees>
  <employee><name>Ryan</name></employee>
  <employee><name>Attacker</name><admin>true</admin></employee>
  <employee><name>Howard</name></employee>
</employees>
```
**Impact:** Attacker created entirely new employee records with arbitrary attributes.

## CodeQL Detection
The vulnerability is detected by CodeQL as:
- **Alert ID:** `cs/xml-injection`
- **Message:** "This XML element depends on a user-provided value"
- **Severity:** High

## Secure Alternative
To fix this vulnerability, use proper XML encoding instead of WriteRaw:

```csharp
// GOOD: Use WriteElementString which properly encodes the input
writer.WriteStartElement("employee");
writer.WriteElementString("name", employeeName);
writer.WriteEndElement();
```

Or use WriteRaw with proper encoding:
```csharp
// GOOD: Encode the user input before using WriteRaw
writer.WriteRaw("<employee><name>" + System.Security.SecurityElement.Escape(employeeName) + "</name></employee>");
```

## Testing
Test cases are provided in `src/WUPHF.Api/WUPHF.Api.http` demonstrating both normal use and attack scenarios.

## References
- CWE-91: XML Injection (https://cwe.mitre.org/data/definitions/91.html)
- OWASP XML Injection: https://owasp.org/www-community/vulnerabilities/XML_Injection
