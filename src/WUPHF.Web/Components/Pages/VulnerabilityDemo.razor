@page "/vulnerability-demo"
@using System.Text
@inject IJSRuntime JSRuntime

<PageTitle>Security Vulnerability Demo</PageTitle>

<div class="container py-4">
    <div class="row">
        <div class="col-md-10 mx-auto">
            <div class="alert alert-warning">
                <h4>?? Security Vulnerability Demonstration</h4>
      <p><strong>WARNING:</strong> This page contains intentional security vulnerabilities for educational purposes only. 
    Do not use this code in production environments!</p>
        </div>

    <div class="card mb-4">
        <div class="card-header bg-danger text-white">
 <h4 class="mb-0">?? XSS Vulnerability Demo</h4>
         <small>Cross-Site Scripting (Reflected XSS)</small>
    </div>
     <div class="card-body">
      <p>This demonstrates a <strong>Reflected XSS vulnerability</strong> where user input is displayed without proper sanitization.</p>
                 
     <EditForm Model="@userInput" OnValidSubmit="@ProcessInput" FormName="XssTestForm">
          <div class="mb-3">
     <label for="userComment" class="form-label">Enter a comment (try entering HTML/JavaScript):</label>
           <InputTextArea id="userComment" class="form-control" rows="3" @bind-Value="userInput.Comment" 
     placeholder="Try: <img src=x onerror=alert('XSS!')>" />
        </div>
     
      <div class="mb-3">
                <label for="userName" class="form-label">Your name:</label>
     <InputText id="userName" class="form-control" @bind-Value="userInput.Name" 
          placeholder="Try: <svg onload=alert('XSS')>" />
               </div>

          <button type="submit" class="btn btn-primary">Submit Comment</button>
          <button type="button" class="btn btn-secondary ms-2" @onclick="ClearOutput">Clear</button>
    </EditForm>
            </div>
        </div>

            @if (!string.IsNullOrEmpty(vulnerableOutput))
         {
 <div class="card mb-4">
    <div class="card-header bg-danger text-white">
       <h5>?? Vulnerable Output (RAW HTML - XSS Risk)</h5>
    </div>
    <div class="card-body">
     <div class="alert alert-danger">
              <strong>VULNERABILITY:</strong> The content below is rendered as raw HTML without sanitization!
        </div>
 <!-- INTENTIONAL VULNERABILITY: Rendering raw HTML -->
                <div class="border p-3" style="background-color: #fff3cd;">
    @((MarkupString)vulnerableOutput)
      </div>
      
            <!-- Additional vulnerability: Direct script injection -->
            @if (!string.IsNullOrEmpty(directScriptInjection))
  {
            <div class="mt-3 border p-3" style="background-color: #ffebee;">
   <strong>Direct Script Injection:</strong><br/>
       @((MarkupString)directScriptInjection)
          </div>
      }
        </div>
  </div>
  }

          <div class="card mb-4">
         <div class="card-header bg-success text-white">
         <h5>? Secure Output (HTML Encoded)</h5>
   </div>
         <div class="card-body">
       @if (!string.IsNullOrEmpty(secureOutput))
{
         <div class="alert alert-success">
<strong>SECURE:</strong> The content below is properly HTML encoded!
                 </div>
  <div class="border p-3" style="background-color: #d4edda;">
            @secureOutput
            </div>
        }
</div>
   </div>

         <div class="card mb-4">
         <div class="card-header bg-info text-white">
   <h4>?? Educational Information</h4>
                </div>
  <div class="card-body">
         <h5>What makes this vulnerable?</h5>
         <ul>
             <li><strong>No Input Validation:</strong> User input is accepted without checking for malicious content</li>
              <li><strong>No Output Encoding:</strong> User input is displayed as raw HTML using <code>@@((MarkupString))</code></li>
          <li><strong>Direct Reflection:</strong> User input is immediately reflected back to the browser</li>
         </ul>

     <h5 class="mt-4">Effective XSS Payloads to Try:</h5>
<div class="row">
     <div class="col-md-6">
     <h6>Image Error (Most Effective):</h6>
            <code>&lt;img src=x onerror=alert('XSS!')&gt;</code>
      </div>
        <div class="col-md-6">
         <h6>SVG OnLoad:</h6>
  <code>&lt;svg onload=alert('XSS')&gt;</code>
                </div>
         </div>
           <div class="row mt-2">
               <div class="col-md-6">
     <h6>Cookie Theft:</h6>
   <code>&lt;img src=x onerror=alert(document.cookie)&gt;</code>
       </div>
           <div class="col-md-6">
 <h6>HTML Injection:</h6>
      <code>&lt;h1 style="color:red"&gt;Hacked!&lt;/h1&gt;</code>
               </div>
               </div>
             <div class="row mt-2">
    <div class="col-md-6">
            <h6>Body OnLoad:</h6>
   <code>&lt;body onload=alert('XSS')&gt;</code>
       </div>
        <div class="col-md-6">
        <h6>Input Focus:</h6>
             <code>&lt;input onfocus=alert('XSS') autofocus&gt;</code>
            </div>
           </div>

           <h5 class="mt-4">How to Fix:</h5>
 <ol>
   <li><strong>Input Validation:</strong> Validate and sanitize all user inputs</li>
      <li><strong>Output Encoding:</strong> Use Blazor's default HTML encoding (don't use <code>MarkupString</code>)</li>
       <li><strong>Content Security Policy:</strong> Implement CSP headers</li>
   <li><strong>Input Sanitization:</strong> Use libraries like HtmlSanitizer for rich content</li>
  </ol>
          </div>
       </div>

            <div class="card">
          <div class="card-header bg-warning">
    <h5>?? Additional Vulnerability: SQL-like Injection Demo</h5>
           </div>
       <div class="card-body">
           <p>This simulates how unsanitized input could be dangerous in database queries:</p>
  
          <EditForm Model="@searchModel" OnValidSubmit="@ProcessSearch" FormName="SqlTestForm">
   <div class="mb-3">
                  <label for="searchQuery" class="form-label">Search Users (try injection):</label>
  <InputText id="searchQuery" class="form-control" @bind-Value="searchModel.Query" 
            placeholder="Try: '; DROP TABLE Users; --" />
            </div>
         <button type="submit" class="btn btn-warning">Search</button>
          </EditForm>

    @if (!string.IsNullOrEmpty(queryResult))
  {
           <div class="alert alert-info mt-3">
              <strong>Simulated Query:</strong><br/>
  <code>@simulatedQuery</code>
</div>
    <div class="alert alert-warning">
  <strong>Result:</strong> @queryResult
           </div>
  }
              </div>
            </div>
        </div>
    </div>
</div>

@code {
    private UserInputModel userInput = new();
    private SearchModel searchModel = new();
    private string vulnerableOutput = string.Empty;
    private string secureOutput = string.Empty;
    private string directScriptInjection = string.Empty;
    private string queryResult = string.Empty;
    private string simulatedQuery = string.Empty;

    public class UserInputModel
    {
     public string Name { get; set; } = string.Empty;
        public string Comment { get; set; } = string.Empty;
    }

    public class SearchModel
    {
        public string Query { get; set; } = string.Empty;
    }

    private async Task ProcessInput()
    {
        // VULNERABLE: Direct HTML output without encoding
        vulnerableOutput = $"<div class='user-comment'><strong>User:</strong> {userInput.Name}<br/><strong>Comment:</strong> {userInput.Comment}</div>";
    
        // Even more vulnerable: Direct script injection to ensure XSS works
      if (!string.IsNullOrEmpty(userInput.Name) || !string.IsNullOrEmpty(userInput.Comment))
      {
        directScriptInjection = $@"
<div id=""vulnerable-content"">
  <p>User Input Rendered Directly:</p>
  <div>{userInput.Name} says: {userInput.Comment}</div>
</div>
<script>
  // This ensures script execution in case other methods fail
  console.log('Vulnerable output rendered');
  // Try to execute any script tags in the content
  var content = document.getElementById('vulnerable-content');
  if (content) {{
     content.innerHTML = content.innerHTML;
  }}
</script>";

     // Use JavaScript interop to execute script if needed (for demonstration)
         if (userInput.Comment.Contains("alert") || userInput.Name.Contains("alert"))
    {
 try
       {
          await JSRuntime.InvokeVoidAsync("eval", "console.log('XSS Vulnerability Demonstration - Script Executed!')");
        }
     catch
       {
    // Ignore errors for demo purposes
      }
         }
        }
      
      // SECURE: Properly encoded output
  secureOutput = $"User: {userInput.Name} - Comment: {userInput.Comment}";
    }

  private void ProcessSearch()
  {
        // Simulate vulnerable SQL query construction
        simulatedQuery = $"SELECT * FROM Users WHERE name = '{searchModel.Query}'";
        
if (searchModel.Query.Contains(";") || searchModel.Query.ToLower().Contains("drop") || 
           searchModel.Query.ToLower().Contains("delete") || searchModel.Query.ToLower().Contains("--"))
        {
            queryResult = "?? DANGER: This input contains SQL injection patterns! In a real application, this could compromise the entire database.";
        }
        else if (string.IsNullOrWhiteSpace(searchModel.Query))
        {
   queryResult = "Please enter a search query.";
        }
  else
        {
       queryResult = $"Searching for users with name containing '{searchModel.Query}' - No results found (simulated).";
        }
    }

    private void ClearOutput()
    {
        vulnerableOutput = string.Empty;
        secureOutput = string.Empty;
     directScriptInjection = string.Empty;
        userInput = new();
        searchModel = new();
        queryResult = string.Empty;
        simulatedQuery = string.Empty;
    }
}}