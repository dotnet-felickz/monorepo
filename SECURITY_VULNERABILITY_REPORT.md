# Security Vulnerability Report - WUPHF API Template Endpoint

## Overview

This document describes the intentional security vulnerabilities introduced in the WUPHF API for educational and testing purposes.

## Primary Vulnerability: Path Traversal (Path Injection)

### Vulnerability Details

- **Type:** Path Traversal / Path Injection (CWE-22)
- **CodeQL Rule:** cs/path-injection
- **Severity:** Critical
- **Location:** `src/WUPHF.Api/Controllers/WuphfController.cs`, line 198
- **Endpoint:** `GET /api/wuphf/template?path={path}`

### Description

The `GetTemplate` endpoint in the WuphfController accepts a user-provided `path` query parameter and directly passes it to `System.IO.File.ReadAllText()` without any validation or sanitization. This allows an attacker to read arbitrary files from the server's filesystem.

### Vulnerable Code

```csharp
[HttpGet("template")]
public ActionResult<object> GetTemplate([FromQuery] string path)
{
    try
    {
        _logger.LogInformation("Reading WUPHF template from path: {Path}", path);

        // BAD: This could read any file on the filesystem.
        // No validation of the path parameter allows path traversal attacks
        string templateContent = System.IO.File.ReadAllText(path);

        return Ok(new
        {
            TemplatePath = path,
            Content = templateContent,
            Message = "Template loaded! Ready to WUPHF!",
            RyanQuote = "This is going to revolutionize the template industry!"
        });
    }
    // ... error handling
}
```

### Attack Scenarios

#### Linux/Unix Systems
```bash
# Read system password file
GET /api/wuphf/template?path=/etc/passwd

# Read application secrets
GET /api/wuphf/template?path=/home/runner/work/monorepo/monorepo/src/WUPHF.Api/appsettings.json

# Read SSH keys
GET /api/wuphf/template?path=/home/user/.ssh/id_rsa
```

#### Windows Systems
```bash
# Read hosts file
GET /api/wuphf/template?path=C:\Windows\System32\drivers\etc\hosts

# Read application configuration
GET /api/wuphf/template?path=C:\inetpub\wwwroot\web.config
```

### Impact

An attacker can:
1. Read sensitive system files (passwords, configuration files)
2. Access application secrets and connection strings
3. Retrieve private keys and certificates
4. Read source code files
5. Access user data and personal information
6. Gather information for further attacks

### CVSS Score (Estimated)

**CVSS v3.1: 9.1 (Critical)**

- Attack Vector: Network (AV:N)
- Attack Complexity: Low (AC:L)
- Privileges Required: None (PR:N)
- User Interaction: None (UI:N)
- Scope: Unchanged (S:U)
- Confidentiality Impact: High (C:H)
- Integrity Impact: None (I:N)
- Availability Impact: None (A:N)

## Secondary Vulnerabilities: Log Forging

### Vulnerability Details

- **Type:** Log Forging (CWE-117)
- **CodeQL Rule:** cs/log-forging
- **Severity:** Medium
- **Locations:** Lines 194, 210, 219

### Description

The endpoint logs user-provided input without sanitization, which could allow an attacker to inject malicious log entries, potentially:
- Hiding malicious activities
- Injecting false log entries
- Exploiting log parsers/viewers
- Triggering log-based alerts inappropriately

### Vulnerable Code

```csharp
_logger.LogInformation("Reading WUPHF template from path: {Path}", path);
_logger.LogWarning("Template file not found: {Path}", path);
_logger.LogError(ex, "Error reading template from {Path}", path);
```

### Attack Example

```bash
# Inject newlines to create fake log entries
GET /api/wuphf/template?path=test.txt%0A[INFO] Fake successful authentication for admin
```

## Remediation

### Fixing Path Traversal

Replace the vulnerable code with proper validation:

```csharp
[HttpGet("template")]
public ActionResult<object> GetTemplate([FromQuery] string templateName)
{
    if (string.IsNullOrWhiteSpace(templateName))
    {
        return BadRequest("Template name is required");
    }

    // Define allowed templates directory
    string templatesDir = Path.GetFullPath(
        Path.Combine(Directory.GetCurrentDirectory(), "templates")
    );
    
    // Sanitize the filename (remove path separators and traversal)
    string safeFileName = Path.GetFileName(templateName);
    
    // Reject suspicious input
    if (safeFileName != templateName || safeFileName.Contains(".."))
    {
        return BadRequest("Invalid template name");
    }
    
    // Build full path
    string fullPath = Path.GetFullPath(Path.Combine(templatesDir, safeFileName));
    
    // Verify the resolved path is within the templates directory
    if (!fullPath.StartsWith(templatesDir + Path.DirectorySeparatorChar))
    {
        _logger.LogWarning("Path traversal attempt blocked: {TemplateName}", templateName);
        return BadRequest("Invalid template name");
    }
    
    // Verify file exists and is a file (not directory)
    if (!System.IO.File.Exists(fullPath))
    {
        return NotFound("Template not found");
    }
    
    try
    {
        string content = System.IO.File.ReadAllText(fullPath);
        return Ok(new
        {
            TemplateName = safeFileName,
            Content = content,
            Message = "Template loaded! Ready to WUPHF!"
        });
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "Error reading template {SafeFileName}", safeFileName);
        return StatusCode(500, "Error reading template");
    }
}
```

### Fixing Log Forging

Sanitize user input before logging or use structured logging:

```csharp
// Option 1: Sanitize input
string safePath = path?.Replace("\n", "").Replace("\r", "");
_logger.LogInformation("Reading WUPHF template from path: {Path}", safePath);

// Option 2: Use structured logging (recommended)
// The framework handles parameter sanitization
_logger.LogInformation("Reading template: {TemplateName}", templateName);
```

## Testing the Vulnerabilities

### Prerequisites
- WUPHF API running on http://localhost:5043
- Access to API endpoints

### Test Cases

#### 1. Legitimate Use (Should Work)
```bash
curl "http://localhost:5043/api/wuphf/template?path=templates/birthday.txt"
```

#### 2. Path Traversal Test (Linux)
```bash
curl "http://localhost:5043/api/wuphf/template?path=/etc/passwd"
```

#### 3. Path Traversal Test (Windows)
```bash
curl "http://localhost:5043/api/wuphf/template?path=C:\Windows\System32\drivers\etc\hosts"
```

#### 4. Relative Path Traversal
```bash
curl "http://localhost:5043/api/wuphf/template?path=../../../../../../etc/passwd"
```

#### 5. Log Forging Test
```bash
curl "http://localhost:5043/api/wuphf/template?path=test.txt%0A%5BINFO%5D%20Fake%20log%20entry"
```

## CodeQL Detection Results

CodeQL successfully detected these vulnerabilities:

1. **Path Injection (cs/path-injection)** - Line 198
   - "This path depends on a user-provided value"
   
2. **Log Forging (cs/log-forging)** - Lines 194, 210, 219
   - "This log entry depends on a user-provided value"

## Prevention Best Practices

### General Guidelines

1. **Never trust user input** - Always validate and sanitize
2. **Use allowlists** - Define allowed values/patterns explicitly
3. **Validate paths** - Use `Path.GetFullPath()` and verify boundaries
4. **Principle of least privilege** - Run with minimal file system permissions
5. **Defense in depth** - Multiple layers of security controls

### Specific to File Operations

1. **Restrict access** - Only allow reading from specific directories
2. **Sanitize filenames** - Remove path separators and traversal sequences
3. **Use Path APIs** - `Path.GetFileName()`, `Path.Combine()`, `Path.GetFullPath()`
4. **Verify boundaries** - Ensure resolved paths are within allowed directories
5. **Consider alternatives** - Use database or resource files instead of filesystem

### Logging Security

1. **Sanitize before logging** - Remove newlines and control characters
2. **Use structured logging** - Let framework handle parameter encoding
3. **Log security events** - Track suspicious activities
4. **Implement log rotation** - Prevent log file attacks
5. **Monitor logs** - Detect and alert on attack patterns

## References

- CWE-22: Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')
  https://cwe.mitre.org/data/definitions/22.html

- CWE-117: Improper Output Neutralization for Logs
  https://cwe.mitre.org/data/definitions/117.html

- OWASP: Path Traversal
  https://owasp.org/www-community/attacks/Path_Traversal

- OWASP: Log Injection
  https://owasp.org/www-community/attacks/Log_Injection

## Disclaimer

**These vulnerabilities are intentionally introduced for educational and security testing purposes.**

**DO NOT deploy this code to production environments.**

**DO NOT use this code in any system that processes real user data.**

This code is provided as-is for:
- Security training and awareness
- Testing security scanning tools
- Demonstrating common vulnerabilities
- Educational purposes only

---

*"I thought I was going to be rich. I mean, I still might be."* - Ryan Howard

**WUPHF Security Team**
